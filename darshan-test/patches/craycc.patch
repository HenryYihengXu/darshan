--- /opt/cray/xt-asyncpe/5.01/bin/craycc	2011-08-12 12:43:14.000000000 -0500
+++ bin/craycc	2012-08-09 15:00:51.179554459 -0500
@@ -1167,6 +1167,27 @@ else
      HDF5_INCFLAGS=
 fi
 
+###
+# Process Darshan libraries
+###
+
+if [ ${CRAY_DARSHAN_DIR:+1} ] ; then
+
+   unset LIBDARSHAN
+   unset DARSHAN_POST_LINK_OPTS
+
+   # disable darshan if dynamic linking
+   if [ "$XTPE_LINK_TYPE" != "dynamic" ] ; then
+      LIBDARSHAN=`${CRAY_DARSHAN_DIR}/bin/darshan-config --post-ld-flags`
+      DARSHAN_POST_LINK_OPTS=`${CRAY_DARSHAN_DIR}/bin/darshan-config --pre-ld-flags`
+   fi
+
+else
+   LIBDARSHAN=
+   DARSHAN_POST_LINK_OPTS=
+fi
+
+
 ##
 # PMI
 ##
@@ -1370,6 +1391,11 @@ if [ -f ${BUILD_OPTS} ] ; then
 	eval $($BUILD_OPTS)
 fi
 
+if [ ${DARSHAN_POST_LINK_OPTS:+1} ] ; then
+   CNL_LIBS_LIST="$CNL_LIBS_LIST $LIBDARSHAN"
+   POST_COMPILE_OPTS="${DARSHAN_POST_LINK_OPTS} ${POST_LINK_OPTS}" 
+fi
+
 _RUN_OPTIONS="$compile_opts $PRE_COMPILE_OPTS $PRE_LINK_OPTS "$@" -hlast_user_arg \
      -nostdinc \
      $INCLUDE_OPTS ${COMPILER_INCLUDE} ${INC_PATH} ${GCC_XX_INCLUDE_PATH_LIST} ${GCC_BASE} $SYSROOT $SYSROOT_INC_PATH \
